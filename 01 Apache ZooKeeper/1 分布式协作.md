## 1 分布式协作

> ZooKeeper is a centralized service for maintaining configuration information, naming, providing distributed synchronization, and providing group services. 

### 1.1 分布式系统

分布式系统是同时跨越多个物理主机，独立运行的多个软件组件所组成的系统。对于分布式系统来说，网络通信是保障分布式运行的重要因素，而在真实的系统中，我们往往需要注意网络通信所关联的一些问题：

* 消息延迟。消息在传输中可能会因为网络阻塞而发生延迟。
* 处理器性能。操作系统的调度和超载可能导致消息处理的延迟。
* 时钟偏移。若处理器时钟不可靠，那么依赖处理器时钟可能会导致错误的结果。

在实际情况中，我们很难判断一个进程是崩溃了还是因为其他原因导致延时。没有收到一个进程发送的消息，可能是该进程已经崩溃，也可能是最新消息发生了网络延迟，也有可能是进程时钟发生了偏移，甚至还有其他的原因。

我们以分布式系统设计的主-从架构为例。要实现主-从模式的系统，我们需要解决三个关键问题：

* 主节点崩溃。如果主节点发送错误并失效，系统将无法分配新的任务或重新分配已失败的任务。
* 从节点崩溃。如果从节点崩溃，已分配的任务将无法完成。
* 通信故障。如果主节点和从节点之间无法进行信息交换，从节点将无法得知新任务分配的情况。

对于主节点崩溃的问题，我们可以设置备份主节点，当主节点崩溃时，备份主节点接管主节点的角色，进行故障迁移。新的主节点需要能够恢复到前主节点崩溃时的状态，对于主节点状态的可恢复性，我们不能依靠从已经崩溃的主节点来获取这些信息。那么从哪里获取呢？答案是ZooKeeper。

我们还要关注到脑裂现象。如果主节点负载过高，导致消息延迟，备份主节点可能会认为主节点已经崩溃，从而成为第二个主节点。由于网络分区错误，一些从节点可能会与第二个主节点通信，从而与其建立新的主-从关系。这样，系统就有两个甚至多个部分开始独立工作，导致整体行为的不一致性。我们需要找出一种方法来避免脑裂现象。

对于从节点崩溃，所有已派发给这个从节点且尚未完成的任务需要重新派发，那么主节点需要具有检测从节点是否崩溃的能力，换句话说，主节点需要得知从节点的状态。

对于通信故障，可能出现的情况是：网络分区导致的从节点与主节点的网络连接断开，那么重新分配某个任务时，可能有多个从节点同时执行该任务。

综上所述，我们可以把主-从架构要关注的任务总结为：

* 主节点选举：主节点可以给从节点分配任务；
* 崩溃检测：主节点能够检测从节点崩溃或失去连接的情况；
* 组成员关系管理：主节点能够判断哪些从节点能够执行任务；
* 元数据管理：主从节点能够通过可靠的方式保存任务的分配状态和执行状态；

## 1.2 ZooKeeper

让一个应用中的多个独立程序协同工作是一件非常困难的事情。ZooKeeper的设计保证了应用的健壮性，使得应用开发人员可以更多地关注应用本身的逻辑，而不是协同工作上。ZooKeeper的设计更专注于任务协作，不提供任何锁的接口或通用存储数据接口。那么ZooKeeper是什么？我们先来看看ZooKeeper的一些使用实例：

* Apache HBase是一个数据存储仓库，ZooKeeper用于选举一个集群内的主节点，以便跟踪可用的服务器，并保存集群的元数据。

* Apache Kafka是一个基于发布-订阅模型的消息系统，ZooKeeper用于监测崩溃，实现主题的实现，并保持主题的生产和消费状态。

* Facebook Message集成了email、短信、Facebook聊天和Facebook收件箱等通信通道，ZooKeeper作为控制器，实现数据分片、故障恢复、服务发现等功能。

当开发人员使用ZooKeeper进行开发时，设计的那些应用往往可以看成一组连接到ZooKeeper服务器的客户端，它们通过ZooKeeper的客户端API连接到ZooKeeper服务器端，进行相应的操作。ZooKeeper的客户端API功能强大，其中包括：

* 保障强一致性、有序性、持久性
* 实现通用的同步原语的能力
* 提供简单的并发处理机制

ZooKeeper满足了处理我们所说的四类任务的能力：主节点选举、崩溃检测、组成员关系管理、元数据管理。它是开源的分布式应用协调服务中间件，为分布式的一致性提供保证。它提供的功能包括：配置管理，命名服务，集群管理，分布式同步。
